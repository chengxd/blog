本章节以需求实现为例，讲解开发流程。重点为开发流程、关键步骤的讲解。

### 需求描述如下：

Terraform Provider support the importing and pushing certificate function(SCM SDK).

Customer gets the certificate from End-user or 3rd party manually. Customer uploads certificate to a PATH manumally. Terraform imports certificate to SCM automatically, Terraform pushes certificate to ELB/WAF/CDN automatically Conclusions:

Terraform can import certificate to SCM from LOCAL PATH certificate file automaticlly. Terraform can push certificate to ELB/WAF/CDN automatically. Need SCM to provide the SCM SDK to Terraform provider.

简单来说，就是用户希望通过Terraform将证书导入的SCM中，并支持将证书推送到ELB/WAF/CDN服务，能够在这些服务中心使用。



### 一、前期准备

- 用于调试的华为云账号，根据需求情况是否需要购买服务，如需购买服务则要确保账号费用充足，本需求不需要购买服务。
- 测试数据，本需求需要准备一个真实的证书数据。
- 分析已经开放的API是否能够满足需求，这个应该是最早要做的，不过在进行需求规划的时候就已经完成分析了。



### 二、启动开发

开发过程简单分为如下几骤：

​		 `设计Terraform Provider&评审`  ->  `封装API为SDK` -> `开发Resource` -> `功能化调试`  -> `编写单元测试` -> `编写文档` -> `提交PR`

#### 1、设计Terraform的脚本

从需求描述上看，客户希望将他们本地的证书文件导入到SCM模块中，并且可以支持将证书推送到其他的服务（ELB/WAF/CDN），可以先到控制台中操作一下，加深对功能的理解。

通过在控制台操作以及分析API，证书导入需要开发一个resource，证书推送是对已有资源的操作，不需要封装为resource。Resource的设计原则请参考：《xxx》-Resource设计原则章节。

- 导入Resource设计如下：

```hcl
resource "huaweicloud_scm_certificate" "certificate_1" {
  name              = "certificate_1""
  certificate       = "-----BEGIN CERTIFICATE-----\nMIIFSDCCBDCgAwIBAgISB"
  certificate_chain = "-----BEGIN CERTIFICATE-----\nMIIFFjCCAv6gAwIBAgIRAJEr"
  private_key       = "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BASC"
}
```

- 证书推送为操作，且同一个证书可以推送到多个服务多个project，添加证书推送后的脚本为：

```hcl
resource "huaweicloud_scm_certificate" "certificate_1" {
  name              = "certificate_1""
  certificate       = "-----BEGIN CERTIFICATE-----\nMIIFSDCCBDCgAwIBAgISB"
  certificate_chain = "-----BEGIN CERTIFICATE-----\nMIIFFjCCAv6gAwIBAgIRAJEr"
  private_key       = "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BASC"
  
  target {
    project  = ["la-south-2", "ap-southeast-1"]
    service  = "WAF"
  }
  
  target {
    project  = ["la-south-2"]
    service  = "Enhance_ELB"
  }
}
```

> 为避免带来无用的工作量，在开发之前应先进行评审，通过评审后再进行开发。



#### 2、将SCM用到的API封装为SDK

1）最先要做的事情是clone代码到本地，先fork golangsdk到个人仓库，并克隆fork后的仓库到本地....请参照【xxx】完成远端仓库的设置、开发分支的创建。每个仓库都需要如此操作。

2）将SCM的导入证书、推送证书和获取证书详情3个API封装到golangsdk中，请参考代码：[Link](https://github.com/huaweicloud/golangsdk/tree/master/openstack/scm/v3/certificates)。

需意如下事项：

- 将出入参封装为struct，struct的属性的命名应该与API中保持一致。如API中字段使用缩写，如过期状态为exp_status，在struct中应该命名为ExpireStatus，不要使用过多的简写。struct代码如下

  ```
  type ImportOpts struct {
  	Name             string `json:"name" required:"true"`
  	Certificate      string `json:"certificate" required:"true"`
  	CertificateChain string `json:"certificate_chain" required:"true"`
  	PrivateKey       string `json:"private_key" required:"true"`
  }
  ```

  > 不足之处：没有给字段写注释，应该要有注释。


其他struct、get、post函数的封装步骤不在详细叙述，参考其他功能开发即可，SDK主要目的是翻译API。



#### 3、开发resource

resource 需要在terraform-provider-huaweicloud中开发，首先要做的是fork、clone代码，参照golangsdk的做法。

开发过程中需要调用golangsdk中的接口，即上述步骤2完成的开发。先将代码copy到vendor/github.com/huaweicloud/golangsdk/openstack/scm下。等完成开发且调试没问题后，在通过go get、go mod vendor的形式从远端加载依赖，最后将依赖的vendor + provider下的脚本一起提交。



**1）在`endpoints.go`中添加service catalog，将SCM的catalog添加到allServiceCatalog中。**

```
var allServiceCatalog = map[string]ServiceCatalog{
	....
	"scm": {
		Name:             "scm",
		Version:          "v3",
		WithOutProjectID: true,
	},
}
```

>  注意： catalog是按照模块分组放在一起的，模块信息写在注释中`// catalog for Application`



**2）在`config.go`中添加client函数，这里也是按模块分组的，client代码如下：**

```
func (c *Config) ScmV3Client(region string) (*golangsdk.ServiceClient, error) {
	return c.NewServiceClient("scm", region)
}
```



**3）创建resource文件，在创建之前要了解工程下面各目录的用途：**

```java
.terraform-provider-huaweicloud
├── docs                         // 文档，发布到Terraform官网的文档
│   ├── data-sources             // data source文档
│   └── resources                // resource的文档
├── examples
├── huaweicloud                  // 资源所在的目录，老的资源/单元测试都是存放在这个目录下的
│   ├── common
│   ├── config
│   ├── services                 // 新规划的目录，新的data source、resource都放在这里按照模块划分，如apig、waf
│   │   ├── acceptance           // 单元测试存放的目录，安装模块划分的，如apig、waf
│   │   │   ├── apig             
│   │   │   ├── deprecated
│   │   │   └── waf
│   │   ├── apig                 // apig模块的data source、resource
│   │   ├── deprecated
│   │   └── waf                  // waf模块
│   ├── xxx.go                   // 公共资源，之前开发的data source、resource
├── scripts                      // 各种脚本
└── vendor                       // 依赖的资源，里面的文件需要提交到git中

```

了解了各目录的用途后，就可以在services下创建脚本文件，如下所示：

```java
│   ├── services
│   │   ├── acceptance
│   │   │   ├── apig
│   │   │   ├── deprecated
│   │   │   ├── waf
│   │   │   └── scm
│   │   │       └── resource_huaweicloud_scm_certificate_v3_test.go  // 单元测试
│   │   ├── apig
│   │   ├── deprecated
│   │   └── waf
│   │   └── scm
│   │       └── resource_huaweicloud_scm_certificate_v3.go           // resource文件
```

完成编码后，调试的时候可以通过单元测试，也可以将provider打包为插件，在本地机器上执行脚本。



**4）向Provider添加我们开发的资源**

在调试之前，需要将我们的resource添加到provider中。在`provider.go`中，找到如下对象，加入我们的资源。

```go
DataSourcesMap: map[string]*schema.Resource {
    ....
    "huaweicloud_scm_certificate": scm.ResourceScmCertificateV3(), 
    ....
}
```

> `DataSourcesMap`: 注册data source资源名称与脚本绑定，使用方式为`data xxxxxx xx {...}`
>
> `ResourcesMap`: 将resource资源名称与脚本绑定，使用方式为`resource xxxxxx xx {...`}

只有完成如上绑定，才可以在脚本中使用`resource huaweicloud_scm_certificate xx {...`}，否则Terraform不认识`huaweicloud_scm_certificate`。



**5）调试：执行单元测试**

- 单元测试实际是在调用真实的服务，需要配置华为云的账号到环境变量中，配置如下：

  ```bash
  export HW_AUTH_URL="https://iam.myhuaweicloud.com:443/v3"
  export HW_REGION_NAME="xxx"
  export HW_DOMAIN_NAME="xxx"
  export HW_USER_NAME="xxx"
  export HW_USER_PASSWORD="xxx"
  
  ```

  其他的环境变量请参考：[Link](https://registry.terraform.io/providers/huaweicloud/huaweicloud/latest/docs#configuration-reference)。

- 无法启动debug调试，可以根据日志分析问题。如需要打印日志，请配置log path的环境变量，如下：

  ```bash
  # TF log
  export TF_LOG=TRACE 
  export TF_LOG_PATH=~/tf.log 
  ```
  
- 通过命令行启动单元测试，如下：

```bash
make testacc TEST='./huaweicloud/services/acceptance/scm' TESTARGS='-run TestScmCertificationPushV3'  
```
> `TEST='./huaweicloud/services/acceptance/scm'`，指定单元测试的包所在目录。
>
> `TESTARGS='-run TestScmCertificationPushV3' ` ，指定要执行的函数，是按照前缀的匹配名称的，可以一次执行多个。



- 最后执行成功后，控制台应打印如下内容：

  ```bash
  make testacc TEST='./huaweicloud/services/acceptance/scm' TESTARGS='-run TestScmCertificationPushV3'  
  ==> Checking that code complies with gofmt requirements...
  TF_ACC=1 go test ./huaweicloud/services/acceptance/scm -v -run TestScmCertificationPushV3 -timeout 360m -parallel 4
  === RUN   TestScmCertificationPushV3
  === PAUSE TestScmCertificationPushV3
  === CONT  TestScmCertificationPushV3
  --- PASS: TestScmCertificationPushV3 (28.18s)
  PASS
  ok      github.com/huaweicloud/terraform-provider-huaweicloud/huaweicloud/services/acceptance/scm       28.246s
  ```



**6）调试：打包插件在使用Terraform调试**

插件调试，实际是华为云provider打包为插件，通过本地仓库的形式加载我们自己的插件。

- 首先是打包，打包命令为：

```bash
$ make fmt
$ make build
```

构建成功后生成的可执行文件位于`~/go/bin/`目录下，文件名：terraform-provider-huaweicloud

- 搭建本地registry，让Terraform从指定的registry下加载插件，详细请参考：[Link](https://support.huaweicloud.com/terraform_faq/index.html)。

- 最后，编写脚本执行`terraform plan`、`terraform apply`，查看结果。



**7）编写文档**

在docs/resources目录下创建md文件，然后编写resource的文档。

注意以下事项：

- 文档格式应当统一，与现有的保持一致。

- usage简单易懂，还要有代表性，最好通过样例就能明白能做什么功能。




### 三、代码提交

一般情况，代码提交分为2步：

- 提交代码到个人仓库
- 提交PR，将个人仓库的分支合并到源端仓库。

提交PR前请参照【XXXX】自检，提交PR时请按模板填写描述，参考【PR优秀样例】。



特别说明，因为`terraform-provider-huaweicloud`是依赖`golangsdk`的，而且在`terraform-provider-huaweicloud`中还要将vendor下的依赖一起提交，因此代码提交步骤如下：

- 功能调试完毕后，提交`golangsdk`的PR。

- 等待`golangsdk`的代码合并完成后再提交`terraform-provider-huaweicloud`的PR，应当包含如下文件：

  - `resource_huaweicloud_scm_certificate_v3.go`和`resource_huaweicloud_scm_certificate_v3_test.go`

  - vendor下的scm用到的相关的SDK文件，`vendor/github.com/huaweicloud/golangsdk/openstack/scm/v3/certificates/requests.go、results.go、urls.go`。

    这些文件原本是本地编编写、修改的，现在要删除，通过go mod vendor从`golangsdk`的master分支上获取最新的代码，不要提交本地的代码。

  - `go.mod`、`go.sum`、`modules.txt`，这三个文件不是每次都有，视情况决定。

    

- 执行go mod vendor后可能会刷新出来其他的依赖文件，但是只提交自己的文件，其他文件checkout还原。

- 再次执行单元测试，确保在标准的使用方式下功能能够正常运行，确定没问题后commit、push、提交PR。



### 四、其他

##### 1、go mod vendor更新本地依赖

```bash
$ go get github.com/huaweicloud/golangsdk@master
$ go mod tidy
$ go mod vendor
```

通过以上步骤，会将vendor下的文件从远端库刷新到本地。

##### 2、API参数问题，请提工单

常见问题出入参字段与接口返回的不一致、按照标准参数调用报错等，都可以通过工单解决。

##### 3、没有测试数据，如本需求证书是需要一个正式的证书的，不可以随便写

找需求方提供数据，账号也可以找他们
